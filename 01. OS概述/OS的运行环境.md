# 第三节、OS 的运行环境

## 目录

- OS 运行机制

  - 两种指令

    - 特权指令
    - 非特权指令

  - 两种状态

    - 核心态
    - 用户态

  - 两种程序

    - 内核程序
    - 应用程序

- 中断和异常

  - 中断作用
  - 中断类型
    - 内中断（也称“异常”）
    - 外中断
  - 中断机制的基本原理

- 系统调用
  - What？
  - 系统调用与库函数的区别
  - 什么功能要用系统调用实现？
  - 系统调用的过程

## 一、OS 运行机制

### 1. 两种指令

    指令是CPU能够识别，执行的基本命令。按照指令是否安全，分为特权指令和非特权指令。

#### 1.1 特权指令

    指的是计算机中不允许用户直接使用的命令，例如：I/O指令、置中断指令、存取用于内存保护的寄存器、送程序状态字到程序状态字寄存器等指令。

    Q: 谁可以使用特权指令？ => 管理程序（内核程序）

#### 1.2 非特权指令

    指的是计算机中用户直接使用的命令。

    Q: 谁可以使用特权指令？ => 被管理程序（应用程序）

### 2. 两种状态

    在分了指令之后，CPU如何判断当前是否可以执行特权指令？于是分出两种不同的处理器状态：核心态和用户态。

#### 2.1 核心态

    也称为管态，此时CPU可以执行所有指令。

#### 2.2 用户态

    也称为目态，只能执行非特权指令。

### 3. 两种程序

    由于有的程序使用特权指令，有的程序使用非特权指令，于是把程序可以分为内核程序和应用程序。

#### 3.2 内核程序

    是系统的管理者，可以执行所有指令，运行在内核态。

#### 3.3 应用程序

    是系统的被管理者，只能执行非特权指令，运行在用户态。

> 【考点】：特权指令和内核程序都只能在核心态运行。
> | 内核态 | 用户态 |
> | ---- | ---- |
> | 中断（缺页程序处理，时钟中断处理），进程调度程序（OS 内核进程），置时钟指令，I/O 指令（输入输出） | 命令解释程序，寄存器清零，取数指令，时钟指令，写内存指令。 |

## 二、中断和异常

### 1. 中断作用

由于系统**不允许用户程序实现核心态的功能**，而他们又必须使用这些功能，因此，通过中断和异常就可以实现用户态进入到核心态。（ps: CPU 运行上层程序时能够使的用户态进入核心态的唯一方法就是通过中断或异常。）**中断是实现多道程序并发执行的关键**。

### 2. 中断的类型

    - 内中断（也称“异常”）
      - 自愿中断 ——————— 指令中断
      - 强迫中断
        - 硬件故障
        - 软件中断
    - 外中断（强迫中断）
      - 外设请求
      - 人的干预

##### 2.1：内中断

    内中断也指异常（Exception）、例外、陷入（trap）。
    指的是源自CPU执行指令内部的事件。
    例如：程序的非法操作码、地址越界、算术溢出、虚拟系统的缺页以及专门的陷入指令等。

##### 2.2：外中断

    指的是源自CPU执行指令以外的事件的发生。
    例如：设备发出的I/O结束中断。

### 3. 中断机制的基本原理

`例子`: 现在有两个进程 p1、p2，在多道程序出现之前，CPU 是一个接一个的执行。而有了中断技术之后，相当于**有个管理者（OS）要介入开展工作**。假设 p1 正在工作，当时间片用完，CPU 受到计时部件发出的中断信号（**OS 开始介入并开展工作**），于是 CPU 将**用户态切换到核心态**，这样除了 OS 其他都不能动了，然后 OS 内核把资源给 p2，并再将**核心态切换到用户态**，于是 p2 开始运行。过了段时间，p2 可能想使用某特权指令（如输出），于是发出系统调用（**主动请求 OS 介入工作**），于是 CPU 又将用户态切回核心态，于是 OS 就让打印机开始工作，由于此时 p2 需要等待打印机，于是 OS 内核又换 p1 继续运行。当打印机完成后，会发出一个 I/O 完成信号，OS 收到信号又开始状态切换，并且将 p2 恢复执行......

    总结：
      1. 当中断发生时，CPU立即进入核心态；
      2. 当中断发生后，当前运行的进程暂停运行，并由OS内核对中断进行处理。
      3. 对于不同的中断信号，会进行不同处理。

> 【注意】：
>
> 1.  “用户态 -> 核心态”的唯一切换方式就是“中断”。但要注意，用户态到核心态转换是由硬件完成的。
> 1.  “核心态 -> 用户态”的切换是执行一个特权指令，将 PSW 的标志位设置为该 CPU 中程序状态寄存器（PSW）所对应的用户态的标志位，例如，多数情况下 0 代表“用户态”，1 代表“核心态”。

## 二、系统调用

### 1. What?

指的是用户在程序中调用操作系统所提供的一些子功能，系统调用可以视为特殊的公共子程序。系统中的各种共享资源都有 OS 统一管理，因此在用户程序中，凡士与资源有关的操作（如存储分配、进行 I/O 传输及文件管理等），都必须通过系统调用的方式像 OS 提出服务请求，并由操作系统代为完成。这样可以保证系统的稳定性和安全性，防止用户进行非法操作。

### 2. 系统调用与库函数的区别

    区别一：系统调用是最底层的应用，面向硬件；库函数的调用是面向开发的；
    区别二：系统调用需要在用户空间和内核上下文环境切换，开销大；而库函数属于过程调用，调用开销小。
    区别三：系统调用调用的是系统内核的服务；库函数调用调用的是函数库中的一段程序，这段程序最终还是通过系统调用来实现。

### 3. 什么功能要用系统调用实现？

    凡士与资源有关的操作（如存储分配、进行I/O传输及文件管理等），都必须通过系统调用的方式像OS提出服务请求，并由操作系统代为完成。

### 4. 系统调用的过程

    用户进程执行 -> 用户进程执行“访管指令/陷入指令”发出系统调用 -> OS把CPU的状态从用户态切换到核心态 -> OS内核程序对系统调用做出相应处理 -> OS把CPU的状态从核心态切换到用户态。
